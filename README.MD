# Проект для мониторинга тендеров

## Описание проекта

Этот проект представляет собой систему для мониторинга тендеров, которая подключается к единой площадке государственных закупок (ЕИС). Он включает в себя несколько компонентов для загрузки, обработки и хранения данных из тендерных заявок в базу данных PostgreSQL, а также генерацию отчетов в различных форматах (PDF, Excel).

Основные компоненты:
- Скачивание данных с площадrb ЕИС.
- Разархивирование и обработка файлов.
- Парсинг и запись данных в базу данных PostgreSQL.
- Автоматическая отправка уведомлений и отчетов пользователям.

## Технические особенности

1. **Работа с базой данных:**
   - PostgreSQL используется для хранения данных о тендерах, заказчиках, подрядчиках и контрактах.
   - Для вставки и обновления данных используются подготовленные SQL-запросы.
   - Важные таблицы: `reestr_contract`, `customer`, `trading_platform`, `links_documentation`.

2. **Работа с XML и JSON:**
   - Программа загружает XML-файлы с данными о тендерах и парсит их с помощью XPath.
   - Теги XML соответствуют значениям в JSON-файлах с определением структуры данных для каждой категории (например, заказчики, контракты).

3. **Структура проекта:**
   - `database_work/`: Папка с модулями для работы с базой данных.
   - `file_delete/`: Папка с модулями для удаления файлов.
   - `parsing_xml/`: Папка с модулями для парсинга xml файлов.
   - `required_tags/`: Папка с json файлами для парсинга xml файлов.
   - `archive_extractor.py`: Модуль с классами для работы с архивами.
   - `config.ini`: Конфигурационные файл для настроек проекта.
   - `eis_requester.py`: Модуль для работы с запросами к ЕИС.
   - `eis_requester.py`: Модуль для работы скачивания файлов.
   - `secondary_functions.py`: Модуль содержит вспомогательные функции.
   - `stunnel_runner.py`: Модуль для запуска stunel.
   - `utils.py`: Модуль для извлечения ссылок из полученного ответа от ЕИС в XML.

# Архитектура проекта

Этот проект состоит из нескольких ключевых компонентов, каждый из которых выполняет свою роль в процессе обработки тендерных данных.
Мы используем объектно-ориентированное программирование, чтобы разделить логику на классы и методы, которые могут взаимодействовать друг с другом.

# Основные компоненты

## 1. Модуль `database_work/database_connection.py` — Модуль для работы с базой данных

### **`class DatabaseManager`** — Класс для подключения к базе данных, выполнения SQL-запросов и управления соединениями.

- **Описание**: Этот класс отвечает за установление соединения с базой данных.
#### Методы класса **`DatabaseManager`**:

- **`execute_query(self, query, params=None)`**
  - **Описание**: Выполняет SQL-запрос, переданный в параметре `query`. Поддерживает выполнение запросов на изменение данных (INSERT, UPDATE, DELETE).
  - **Параметры**:
    - `query` (str): Строка SQL-запроса, который будет выполнен.
    - `params` (tuple, optional): Кортеж с параметрами для подстановки в запрос (по умолчанию `None`).
    - 
  - **Возвращает**: `None`

- **`fetch_one(self, query, params=None)`**
  - **Описание**: Выполняет SELECT-запрос и возвращает одну строку данных.
  - **Параметры**:
    - `query` (str): Строка SQL-запроса для выборки данных.
    - `params` (tuple, optional): Кортеж с параметрами для подстановки в запрос (по умолчанию `None`).
  - **Возвращает**: `tuple` или `None`

- **`fetch_all(self, query, params=None)`**
  - **Описание**: Выполняет SELECT-запрос и возвращает все строки данных.
  - **Параметры**:
    - `query` (str): Строка SQL-запроса для выборки данных.
    - `params` (tuple, optional): Кортеж с параметрами для подстановки в запрос (по умолчанию `None`).
  - **Возвращает**: `list` (Список кортежей)

- **`close(self)`**
  - **Описание**: Закрывает соединение с базой данных.
  - **Параметры**: Отсутствуют.
  - **Возвращает**: `None`

## 2. Модуль `database_work/check_database.py` — Модуль для проверки данных в базе данных.

### **`class DatabaseChecker`** — Класс для выполнения проверок данных в базе данных.

- **Описание**: Этот класс отвечает за выполнение проверок на наличие или корректность данных в таблицах базы данных.

#### Методы класса **`DatabaseChecker`**:

- **`check_if_exists(self, table, column, value)`**
  - **Описание**: Проверяет, существует ли запись в указанной таблице с заданным значением в указанном столбце.
  - **Параметры**:
    - `table` (str): Имя таблицы, в которой нужно выполнить проверку.
    - `column` (str): Имя столбца, в котором нужно искать значение.
    - `value` (str): Значение, которое нужно найти в столбце.
  - **Возвращает**: `bool` (True или False)

- **`check_customer_exists(self, customer_id)`**
  - **Описание**: Проверяет, существует ли клиент с заданным `customer_id`.
  - **Параметры**:
    - `customer_id` (int): Идентификатор клиента для проверки.
  - **Возвращает**: `bool` (True или False)

## 3. Модуль `database_work/database_id_fetcher.py` — Модуль для получения ID записей из базы данных.

### **`class DatabaseIdFetcher`** — Класс для получения уникальных идентификаторов записей в базе данных.

- **Описание**: Этот класс используется для извлечения уникальных идентификаторов записей из различных таблиц базы данных.

#### Методы класса **`DatabaseIdFetcher`**:

- **`get_customer_id(self, contact)`**
  - **Описание**: Получает `id` клиента на основе ФИО (контакта).
  - **Параметры**:
    - `contact` (str): ФИО клиента для поиска.
  - **Возвращает**: `int` (Идентификатор клиента или `None`, если не найдено)

- **`get_contract_id(self, contract_number)`**
  - **Описание**: Получает `id` контракта на основе его номера.
  - **Параметры**:
    - `contract_number` (str): Номер контракта для поиска.
  - **Возвращает**: `int` (Идентификатор контракта или `None`, если не найдено)

---

Этот формат помогает четко указать все классы и их методы, а также что они делают, какие параметры принимают и что возвращают.



2. **Основной процесс**:
   - Данные загружаются с тендерных площадок.
   - XML-файлы обрабатываются с использованием классов для парсинга.
   - Все данные, включая информацию о заказчиках, контрактах и торговых площадках, сохраняются в базе данных.

## Описание классов и методов

### 1. Класс **TenderParser**

Класс `TenderParser` отвечает за парсинг XML-файлов и извлечение информации для различных таблиц (например, `customer`, `reestr_contract`).

#### Основные методы:
- **`parse_customer(root, tags, region_code)`**:
    - **Параметры**:
        - `root` (Element): Корневой элемент XML-документа.
        - `tags` (dict): Словарь с тегами для парсинга, передаваемый из конфигурации.
        - `region_code` (str): Код региона, который будет добавлен в данные.
    - **Описание**: Этот метод парсит данные для таблицы `customer`, извлекая информацию из указанных тегов и добавляя код региона.

- **`parse_reestr_contract(root, tags)`**:
    - **Параметры**:
        - `root` (Element): Корневой элемент XML-документа.
        - `tags` (dict): Теги для парсинга.
    - **Описание**: Парсит данные для таблицы `reestr_contract`.

### 2. Класс **DatabaseManager**

Класс `DatabaseManager` отвечает за все операции с базой данных, такие как подключение, выполнение запросов, вставка и обновление данных.

#### Основные методы:
- **`insert_customer(customer_data, customer_id)`**:
    - **Параметры**:
        - `customer_data` (dict): Данные клиента для вставки или обновления.
        - `customer_id` (int): ID клиента, который будет обновлен.
    - **Описание**: Вставляет или обновляет данные о клиенте в таблице `customer`. Сравнивает текущие данные с новыми и обновляет только изменившиеся поля.

- **`get_connection()`**:
    - **Описание**: Устанавливает и возвращает подключение к базе данных.

### 3. Класс **FileProcessor**

Этот класс управляет работой с файлами, такими как скачивание, разархивирование и обработка файлов.

#### Основные методы:
- **`unzip_file(file_path, extract_path)`**:
    - **Параметры**:
        - `file_path` (str): Путь к архивированному файлу.
        - `extract_path` (str): Путь, куда будет разархивирован файл.
    - **Описание**: Разархивирует файл в указанную папку.

- **`download_file(url, destination)`**:
    - **Параметры**:
        - `url` (str): URL файла для скачивания.
        - `destination` (str): Путь для сохранения скачанного файла.
    - **Описание**: Скачивает файл по указанному URL.

## Взаимодействие классов и методов

Взаимодействие между классами происходит следующим образом:

1. Класс **TenderParser** инициирует процесс парсинга XML, передавая данные о файле и теги.
    - Метод `parse_customer` получает данные, парсит их и добавляет код региона в результат.

2. После парсинга данных, класс **DatabaseManager** использует метод `insert_customer`, чтобы вставить или обновить данные в таблице базы данных.

3. Класс **FileProcessor** управляет загрузкой и обработкой файлов, например, разархивированием или скачиванием тендерных данных, которые затем передаются в `TenderParser` для дальнейшего парсинга.

## Пример работы программы

### 1. Загрузка и парсинг данных

Пример использования класса `TenderParser` для парсинга данных о клиенте:

```python
customer_data = tender_parser.parse_customer(xml_root, tags['customer'], region_code='RU-01')
database_manager.insert_customer(customer_data, customer_id=123)
## Установка

### Требования

- Python 3.x
- PostgreSQL
- Установленные зависимости из файла `requirements.txt`.

### Установка зависимостей

```bash
pip install -r requirements.txt
```

# Старт с StunnelRunner

## Описание
Модуль StunnelRunner предназначен для запуска утилиты stunnel_msspi.exe
с указанным конфигурационным файлом, перенаправляя логи в файл для последующего анализа.
Этот модуль полезен для автоматизации процесса подключения через stunnel,
что используется для безопасных соединений в рамках различных приложений.

## Установка
Скачайте и установите Stunnel на свой компьютер.
Скопируйте необходимые файлы, включая stunnel_msspi.exe и конфигурационный файл stunnel.conf, в папку проекта.
Убедитесь, что Python 3.9 установлен на вашей системе.
Установите необходимые зависимости:
```
pip install loguru
```

## Использование
#### 1. Подключение модуля
Для использования класса StunnelRunner создайте новый Python файл и импортируйте класс:
```
from stunnel_runner import StunnelRunner
```
#### 2. Настройка и запуск
- Для того чтобы запустить stunnel, вам необходимо передать путь к директории с stunnel_msspi.exe
и конфигурационному файлу stunnel.conf.
- Перед использованием необходимо настроить файл конфигурации `config.ini`
с нужными значениями и установить токен в файле `.env`.

## Пример использования:
```
from stunnel_runner import StunnelRunner

# Настройка
if __name__ == "__main__":
    stunnel_dir = r"E:\Программирование\Парсинг ЕИС\stunel"  # Путь к директории с stunnel
    config_file = "stunnel.conf"  # Название конфигурационного файла

    # Создание экземпляра и запуск
    stunnel_runner = StunnelRunner(stunnel_dir, config_file)
    stunnel_runner.run_stunnel()
```

## Логика работы системы

Система для получения и обработки данных включает несколько ключевых этапов:

### 1. Получение данных через SOAP-запрос
Метод `send_soap_request` в модуле `eis_requester.py` выполняет запрос к API, который возвращает необходимые файлы. Затем эти файлы скачиваются с помощью метода `download_files` в модуле `file_downloader.py`.

### 2. Скачивание и разархивация файлов
После получения URL-адресов для скачивания, файлы загружаются и разархивируются с помощью соответствующих методов. Метод `download_files` скачивает файлы, а `unzip_files` разархивирует их.

### 3. Обработка ОКПД
После разархивации, каждый файл проверяется на наличие ОКПД через метод `process_okpd_files`, который сверяет полученные данные с уже имеющимися записями в базе данных. Если файл уже был обработан, он удаляется. В противном случае, продолжается дальнейшая обработка данных.

### 4. Получение и передача ID региона
В случае нахождения соответствия ОКПД в базе данных, из метода `send_soap_request` извлекается номер региона, который передается в функцию `get_region_id` для получения ID региона.

### 5. Парсинг данных о заказчике
Далее, данные из XML-файла, такие как информация о заказчике, парсятся с помощью функции `parse_customer`, которая извлекает нужные теги из файла.

### 6. Вставка данных в базу данных
После парсинга, данные передаются в функцию `insert_customer`, которая вставляет информацию о заказчике в таблицу `customer` базы данных, включая ID региона.

### Описание структуры
- **Модуль `eis_requester.py`**: Отправка SOAP-запросов и получение файлов.
- **Модуль `file_downloader.py`**: Скачивание и разархивация файлов.
- **Модуль `parsing_xml.okpd_parser.py`**: Проверка и обработка ОКПД.
- **Модуль `database_work.check_database.py`**: Проверка данных в базе.
- **Модуль `database_id_fetcher.py`**: Получение ID региона.
- **Модуль `xml_parser.py`**: Парсинг данных из XML.
- **Модуль `database_operations.py`**: Вставка данных в базу.

Все эти компоненты взаимодействуют друг с другом, создавая последовательный процесс обработки и внесения данных в систему.

3. Логи
Логи выполнения команды stunnel будут записаны в файл stunnel.log. Вы можете использовать этот файл для диагностики ошибок, таких как неверный путь, неправильная конфигурация или проблемы с запуском.

4. Примечания
Убедитесь, что пути указаны корректно, и используйте абсолютные пути для большей уверенности.
Запуск происходит в командной оболочке (через cmd.exe), что позволяет работать с относительными путями.

## Структура базы данных
База данных содержит 16 таблиц:

- region — справочник регионов.
- dates — даты внесения данных.
- file_names_xml — названия XML-файлов.
- customer — информация о заказчиках.
- contractor — информация о подрядчиках.
- trading_platform — торговые площадки.
- collection_codes_okpd — классификатор ОКПД.
- reestr_contract_44_fz — контракты по 44-ФЗ.
- links_documentation_44_fz — ссылки на документацию 44-ФЗ.
- reestr_contract_223_fz — контракты по 223-ФЗ.
- links_documentation_223_fz — ссылки на документацию 223-ФЗ.
- stop_words_names — стоп-слова.
- key_words_names — ключевые слова.
- key_words_names_documentations — ключевые слова в документации.
- users — информация о пользователях.
- okpd_from_users — ОКПД пользователей.

🔗 Связи между таблицами
- region ↔ customer (по региону заказчика).
- customer ↔ reestr_contract_44_fz / reestr_contract_223_fz (контракты заказчика).
- trading_platform ↔ reestr_contract_44_fz / reestr_contract_223_fz (на какой площадке проводились торги).
- contractor ↔ reestr_contract_44_fz / reestr_contract_223_fz (кто является подрядчиком по контракту).
- collection_codes_okpd ↔ reestr_contract_44_fz / reestr_contract_223_fz (код ОКПД контракта).
- links_documentation_44_fz ↔ reestr_contract_44_fz (ссылки на документацию по 44-ФЗ).
- links_documentation_223_fz ↔ reestr_contract_223_fz (ссылки на документацию по 223-ФЗ).
- stop_words_names, key_words_names, key_words_names_documentations ↔ users (пользовательские настройки фильтрации).
- okpd_from_users ↔ reestr_contract_44_fz / reestr_contract_223_fz (пользовательские настройки поиска по ОКПД).

📌 Использование базы данных
1. Запустите PostgreSQL сервер.
2. Создайте базу данных с помощью CREATE DATABASE Tender_Monitor;
3. Запустите SQL-скрипт для создания таблиц.
4. Начните добавлять и анализировать данные.

GNU GENERAL PUBLIC LICENSE
Version 3, 07 February 2025
...
